redcap:
  extraInitContainers:
    - name: init-redcap-retriever-rclone
      image: "bitnami/rclone:latest"
      imagePullPolicy: Always

      securityContext:
        allowPrivilegeEscalation: false
        runAsUser: 2000
        runAsGroup: 2000

      env:
      - name: REDCAP_INIT
        value: "TRUE"
      - name: REDCAP_PACKAGE_PATH
        value: "redcap-packages/redcap-13-1-16.zip"
      - name: REDCAP_LOCALIZATION_PATH
        value: "redcap-translations/Francais_11.3.1.ini"
      - name: RCLONE_CONFIG_SOURCE_TYPE
        value: "s3"
      - name: RCLONE_CONFIG_SOURCE_PROVIDER
        value: "Other"
      - name: RCLONE_CONFIG_SOURCE_ENV_AUTH
        value: "false"
      - name: RCLONE_CONFIG_SOURCE_ACL
        value: "private"
      - name: RCLONE_CONFIG_SOURCE_REGION
        value: "gra"
      - name: RCLONE_CONFIG_SOURCE_LOCATION_CONSTRAINT
        value: "gra"
      - name: RCLONE_CONFIG_SOURCE_ENDPOINT
        value: "https://s3.gra.io.cloud.ovh.net/"
      - name: RCLONE_CONFIG_SOURCE_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: redcap-ext-qual-s3-creds
            key: ACCESS_KEY_ID
      - name: RCLONE_CONFIG_SOURCE_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: redcap-ext-qual-s3-creds
            key: SECRET_ACCESS_KEY

      command:
      - "/bin/bash"
      - "-c"
      - |-
        if [[ "$REDCAP_INIT" != TRUE ]]; then echo "REDCap package retrieve set to false, canceling operation"; exit 0; fi
        echo "Retrieving REDCap packages from source"
        rclone -P -v copyto "source:$REDCAP_PACKAGE_PATH" /tmp/redcap.zip
        rclone -P -v copyto "source:$REDCAP_LOCALIZATION_PATH" /tmp/localization.ini
        echo "Done"

      volumeMounts:
      - name: init-redcap-tmp
        mountPath: /tmp

    - name: init-redcap-install
      image: "alpine:latest"
      imagePullPolicy: Always

      securityContext:
        allowPrivilegeEscalation: false
        runAsUser: 2000
        runAsGroup: 2000

      command: 
      - "/bin/ash"
      - "-c"
      - |-
        if [ -z "$( ls -A '/tmp' )" ]; then echo "No REDCap packages found, skipping installaton"; exit 0; fi
        echo "Found REDCap packages, proceeding to installation"
        unzip -o /tmp/redcap.zip -d /tmp
        mv -f /tmp/redcap/* /redcap
        mf -f /tmp/localization.ini /redcap/languages
        rm -rf /tmp/*
        echo "Done"

      volumeMounts:
      - name: redcap-code
        mountPath: /redcap
      - name: init-redcap-tmp
        mountPath: /tmp

  extraVolumes:
  - name: init-redcap-tmp
    emptyDir:
      sizeLimit: 100Mi